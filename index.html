<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Circonscriptions électorales</title>
    <link rel="stylesheet" href="//rawgithub.com/Caged/d3-tip/master/examples/example-styles.css">
    <style>
        #selector {
            margin: 20px auto;
            max-width: 300px;
        }

        #selector select {
            display: block;
            width: 100%;
        }

        #content {
            display: flex;
        }

        #hexagone {
            width: 960px;
            height: 950px;
        }

        #details div {
            margin: 0 10px;
            padding: 10px;
            border: 1px solid black;
        }

        svg, g {
            pointer-events: none;
        }

        path {
            pointer-events: all !important;
        }

        .d3-tip {
            z-index: 1000;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
          integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
          crossorigin=""/>
</head>
<body>
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.js"></script>
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
        integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
        crossorigin=""></script>
<script src="//d3js.org/d3.v4.min.js" charset="utf-8"></script>
<script src="//d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.js"></script>
<script src="//d3js.org/topojson.v3.js"></script>

<div id="selector"></div>
<div id="content">
    <div id="hexagone"></div>
    <div id="details"></div>
</div>

<script>
  const select = d3.select("#selector").append('select');

  const tip = d3.tip()
    .attr('class', 'd3-tip')
    .html(function (d) {
      return nomCirco(d);
    });

  const map = new L.Map("hexagone", {center: [46.72, -2], zoom: 5})
    .addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));

  const width = 960, height = 950;
  const svg = d3.select(map.getPanes().overlayPane).append("svg")
    .call(tip);
  const hexagone = svg.append('g').attr('class', 'leaflet-zoom-hide');

  // graph détails
  const gWidth = 500;
  const gHeight = 400;
  const labelsWitdh = 100;
  const scaleHeight = 20;

  const details = d3.select('#details').append('div');
  const title = details.append('h2');
  const graph = details.append('svg')
    .attr('height', gHeight + scaleHeight)
    .attr('width', gWidth + labelsWitdh);

  const results = graph.append('g')
    .attr('transform', 'translate(' + labelsWitdh + ',0)');

  const labels = results.append('g')
    .attr('class', 'axis axis--y');

  const echelle = results.append('g')
    .attr('class', 'axis axis--x')
    .attr('transform', 'translate(0,' + gHeight + ')');

  const x = d3.scaleLinear().rangeRound([0, gWidth]);
  const y = d3.scaleBand().rangeRound([0, gHeight]).padding(0.1);

  const choices = [
    ['votes.MÉLENCHON', 'Mélenchon'],
    ['votes.MACRON', 'Macron'],
    ['votes.LE PEN', 'Le Pen'],
    ['votes.FILLON', 'Fillon'],
    ['votes.HAMON', 'Hamon'],
    ['rang', 'Rang de Mélenchon'],
    ['qualifie', '> 12,5 % des inscrits pour Mélenchon'],
    ['force', 'Score de Mélenchon (en dizaines de %)']
  ];


  select.selectAll('option').data(choices)
    .enter()
    .append('option')
    .attr('value', function (d) {
      return d[0];
    })
    .text(function (d) {
      return d[1];
    });

  const sc = d3.interpolateReds;

  const colorScales = {
    'votes.MÉLENCHON': d3.scaleSequential(d3.interpolateReds).domain([0, 0.5]),
    'votes.MACRON': d3.scaleSequential(d3.interpolateOranges).domain([0, 0.5]),
    'votes.LE PEN': d3.scaleSequential(d3.interpolateGreys).domain([0, 0.5]),
    'votes.FILLON': d3.scaleSequential(d3.interpolatePurples).domain([0, 0.5]),
    'votes.HAMON': d3.scaleSequential(d3.interpolateReds).domain([0, 0.5]),
    'rang': d3.scaleSequential(d3.interpolateReds).domain([5, 1]),
    'qualifie': d3.scaleOrdinal(["#ff5943", "#e2e2e2"]).domain(true, false),
    'force': d3.scaleOrdinal([sc(0), sc(.33), sc(.66), sc(1)]).domain(['-10%', '10-20%', '20-30%', '+30%'])
  };

  const barColors = {
    'ARTHAUD': "#c41114",
    'ASSELINEAU': "#057c85",
    'CHEMINADE': "#e53517",
    'DUPONT-AIGNAN': "#39394b",
    'FILLON': "#23408f",
    'HAMON': "#e0003c",
    'LASSALLE': "#ff9632",
    'LE PEN': "#2f3e4b",
    'MÉLENCHON': "#ff3f19",
    'POUTOU': "#ff1f17",
    'MACRON': '#ffe037'
  };

  function nomCirco(d) {
    return `${d.properties.nom_dpt}, ${d.properties.num_circ}${d.properties.num_circ === '1' ? 'ère' : 'ème'} circonscription`;
  }

  function showDetails(feature) {
    title.text(nomCirco(feature));

    const votes = feature.properties.votes;

    const candidats = Object.keys(votes).sort(function (a, b) {
      return votes[a] - votes[b];
    }).reverse().slice(0, 5);
    const scoreMax = d3.max(candidats.map(function (c) {
      return votes[c];
    }));

    const data = candidats.map(function (c) {
      return {candidat: c, score: votes[c]};
    });

    y.domain(candidats);
    x.domain([0, Math.max(0.25, scoreMax)]);

    labels.call(d3.axisLeft(y));
    echelle.call(d3.axisBottom(x).ticks(5, '%'));

    const bars = results.selectAll('.bar').data(data, function (d) {
      return d.candidat;
    });

    bars.enter()
      .append('rect')
      .attr('class', 'bar')
      .attr('x', 0)
      .merge(bars)
      .attr('y', function (d) {
        return y(d.candidat);
      })
      .attr('height', y.bandwidth())
      .attr('width', function (d) {
        return x(d.score);
      })
      .attr('fill', function (d) {
        return barColors[d.candidat];
      });

    bars.exit().remove();
  }

  function projectPoint(x, y) {
    const point = map.latLngToLayerPoint(new L.LatLng(y, x));
    this.stream.point(point.x, point.y);
  }

  const transform = d3.geoTransform({point: projectPoint}),
    path = d3.geoPath().projection(transform);

  function draw(collection, choice) {
    console.log('draw');
    const t = d3.transition().duration(750);

    const circos = hexagone.selectAll('.circos').data(collection.features, function (d) {
      return d.properties.ID;
    });

    const bounds = path.bounds(collection),
      topLeft = bounds[0],
      bottomRight = bounds[1];

    svg
      .attr("width", bottomRight[0] - topLeft[0])
      .attr("height", bottomRight[1] - topLeft[1])
      .style("left", topLeft[0]+'px')
      .style("top", topLeft[1]+'px');

    hexagone.attr('transform', "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

    // Enter
    circos.enter().append('path')
      .attr('class', 'circos')
      .on('mouseover.tip', tip.show)
      .on('mouseout.tip', tip.hide)
      .on('mouseover.details', showDetails)
      // UPDATE
      .merge(circos)
      .attr('d', path)
      .transition(t)
      .attr('fill', function (d) {
        return colorScales[choice](_.get(d.properties, choice));
      });
  }

  d3.json("data/circos_exprimes.json", function (error, topology) {
    if (error) return console.error(error);

    window.topology = topology;

    const collection = topojson.feature(topology, topology.objects.circos);

    draw(collection, 'votes.MÉLENCHON');

    function redraw() {
      draw(collection, select.node().value);
    }

    select.on('change', redraw);
    map.on('viewreset', redraw);
    map.on('zoom', redraw);
  })
</script>
</body>
</html>
